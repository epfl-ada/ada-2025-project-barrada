<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Social Roles</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* ACADEMIC STYLE CSS */
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: #2c3e50;
            margin-bottom: 5px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            width: 100%;
            max-width: 1000px;
            text-align: center;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
            text-align: center;
        }

        #dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 100%;
            max-width: 1200px;
        }

        #donut-container {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .center-text {
            font-size: 24px;
            font-weight: bold;
            fill: #333;
            font-family: Georgia, serif;
        }
        .center-subtext {
            font-size: 12px;
            fill: #777;
        }

        #details-container {
            flex: 1;
            min-width: 300px;
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
        }

        .role-panel {
            background: #fff;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .role-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .bar-label {
            font-size: 11px;
            fill: #333;
        }

        .bar-value {
            font-size: 10px;
            fill: #666;
            font-weight: bold;
        }

        /* TOOLTIP */
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 12px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>

    <h2>Fig 1. The Social Role Ecosystem</h2>
    <div class="subtitle">Distribution of behavioral roles across 67,180 subreddits.</div>

    <div id="dashboard">
        <div id="donut-container">
            <h3>Global Distribution</h3>
            <div id="donut-chart"></div>
        </div>

        <div id="details-container">
            </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // --- CONFIGURATION ---
        // Distinct, Colorblind-safe palette
        const COLORS = {
            "Neutral": "#e0e0e0",         // Light Grey (Background noise)
            "Influential": "#f1c40f",     // Gold (Power)
            "Supportive": "#27ae60",      // Green (Help)
            "Controversial": "#8e44ad",   // Purple (Conflict Magnet)
            "Critical": "#c0392b"         // Red (Attacker)
        };

        const DESCRIPTIONS = {
            "Influential": "High PageRank, Positive Incoming",
            "Supportive": "High Positive Outgoing",
            "Controversial": "High Negative Incoming",
            "Critical": "High Negative Outgoing"
        };

        async function initDashboard() {
            try {
                const data = await d3.json('../data/roles.json');
                
                drawDonut(data.distribution);

                const roles = ["Influential", "Supportive", "Controversial", "Critical"];
                roles.forEach(role => {
                    if (data.top_by_role[role]) {
                        drawDetailPanel(role, data.top_by_role[role]);
                    }
                });

            } catch (error) {
                console.error("Error loading data:", error);
                document.body.innerHTML += `<p style='color:red; text-align:center;'>Error loading data: ${error.message}</p>`;
            }
        }

        function drawDonut(distData) {
            const width = 400;
            const height = 400;
            const margin = 20;
            const radius = Math.min(width, height) / 2 - margin;

            const svg = d3.select("#donut-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width/2}, ${height/2})`);

            const dataArray = Object.entries(distData).map(([key, value]) => ({key, value}));
            
            dataArray.sort((a, b) => {
                if (a.key === "Neutral") return 1;
                if (b.key === "Neutral") return -1;
                return b.value - a.value;
            });

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null); // Use our custom sort

            const arc = d3.arc()
                .innerRadius(radius * 0.6) // Creates the hole
                .outerRadius(radius);
            
            const arcHover = d3.arc()
                .innerRadius(radius * 0.6)
                .outerRadius(radius + 10);

            // Draw Segments
            const path = svg.selectAll('path')
                .data(pie(dataArray))
                .join('path')
                .attr('d', arc)
                .attr('fill', d => COLORS[d.data.key] || "#ccc")
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .style("cursor", "pointer")
                .on('mouseover', function(event, d) {
                    d3.select(this).transition().duration(200).attr('d', arcHover);
                    d3.select(".center-text").text(d.data.value.toFixed(1) + "%");
                    d3.select(".center-subtext").text(d.data.key);
                })
                .on('mouseout', function(d) {
                    d3.select(this).transition().duration(200).attr('d', arc);
                    d3.select(".center-text").text("100%");
                    d3.select(".center-subtext").text("All Subreddits");
                });

            // Center Text
            svg.append("text")
                .attr("class", "center-text")
                .attr("text-anchor", "middle")
                .attr("dy", "-5px")
                .text("100%");

            svg.append("text")
                .attr("class", "center-subtext")
                .attr("text-anchor", "middle")
                .attr("dy", "15px")
                .text("All Subreddits");
            
        }

        function drawDetailPanel(role, clusterList) {
            const container = d3.select("#details-container");
            
            const panel = container.append("div").attr("class", "role-panel");
            
            // Title Header
            panel.append("div")
                .attr("class", "role-title")
                .style("color", COLORS[role])
                .html(`<span>${role}</span> <span style='font-weight:normal; font-size:11px; color:#999'>Top Clusters</span>`);

            const width = 250;
            const height = 150;
            const margin = {top: 10, right: 30, bottom: 10, left: 110};

            const svg = panel.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X Scale
            const maxVal = d3.max(clusterList, d => d.pct);
            const x = d3.scaleLinear()
                .domain([0, maxVal * 1.2])
                .range([0, width]);

            // Y Scale
            const y = d3.scaleBand()
                .range([0, height])
                .domain(clusterList.map(d => d.name))
                .padding(0.2);

            // Draw Bars
            svg.selectAll("rect")
                .data(clusterList)
                .join("rect")
                .attr("x", x(0))
                .attr("y", d => y(d.name))
                .attr("width", d => x(d.pct))
                .attr("height", y.bandwidth())
                .attr("fill", COLORS[role])
                .attr("rx", 3);

            // Labels (Cluster Names)
            svg.selectAll(".bar-label")
                .data(clusterList)
                .join("text")
                .attr("class", "bar-label")
                .attr("x", -5)
                .attr("y", d => y(d.name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .text(d => d.name.length > 15 ? d.name.substring(0,14)+"..." : d.name);

            // Values (%)
            svg.selectAll(".bar-value")
                .data(clusterList)
                .join("text")
                .attr("class", "bar-value")
                .attr("x", d => x(d.pct) + 5)
                .attr("y", d => y(d.name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .text(d => d.pct.toFixed(1) + "%");
        }

        initDashboard();

    </script>
</body>
</html>