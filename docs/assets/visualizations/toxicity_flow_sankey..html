<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Toxicity Flow Sankey</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, Helvetica, sans-serif;
            background: #fafafa;
        }

        #container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        #header h1 {
            margin: 0 0 5px 0;
            font-size: 22px;
            color: #333;
        }

        #header p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        #chart {
            flex: 1;
            background: white;
            position: relative;
        }

        svg {
            display: block;
        }

        .node rect {
            cursor: move;
            fill-opacity: 0.9;
            stroke: #fff;
            stroke-width: 2px;
        }

        .node rect:hover {
            fill-opacity: 1;
        }

        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: 500;
            fill: #333;
        }

        .link {
            fill: none;
            stroke-opacity: 0.3;
        }

        .link:hover {
            stroke-opacity: 0.5;
        }

        .tooltip {
            position: absolute;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>Toxicity Flow: Aggressors → Systemic Toxicity → Victims</h1>
            <p>Drag nodes to rearrange • Hover for details</p>
        </div>
        <div id="chart"></div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        const margin = {top: 20, right: 200, bottom: 20, left: 200};
        const width = window.innerWidth - margin.left - margin.right;
        const height = window.innerHeight - 100 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");

        const colors = {
            aggressor: "#e74c3c",
            hub: "#95a5a6", 
            victim: "#3498db"
        };

        Promise.all([
            d3.json('../data/toxicity.json'),
            d3.json('../data/nodes.json')
        ]).then(([data, nodeNames]) => {

            const nodes = [];
            const links = [];
            
            nodes.push({
                id: 0,
                name: "Systemic\nToxicity",
                type: "hub"
            });

            let nodeId = 1;

            data.bullies.forEach(d => {
                const flowValue = Math.abs(d.net_flow);
                nodes.push({
                    id: nodeId,
                    name: d.cluster, 
                    type: "aggressor",
                    flow: flowValue
                });
                links.push({
                    source: nodeId,
                    target: 0,
                    value: flowValue
                });
                nodeId++;
            });

            data.victims.forEach(d => {
                const flowValue = Math.abs(d.net_flow);
                nodes.push({
                    id: nodeId,
                    name: nodeNames[d.cluster]?.name || `Cluster ${d.cluster}`,
                    type: "victim",
                    flow: flowValue
                });
                links.push({
                    source: 0,
                    target: nodeId,
                    value: flowValue
                });
                nodeId++;
            });

            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(18)
                .nodePadding(10)
                .extent([[1, 1], [width - 1, height - 5]]);

            const {nodes: sankeyNodes, links: sankeyLinks} = sankey({
                nodes: nodes.map(d => Object.assign({}, d)),
                links: links.map(d => Object.assign({}, d))
            });

            // Draw links
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(sankeyLinks)
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", d => {
                    if (d.source.type === "aggressor") return colors.aggressor;
                    return colors.victim;
                })
                .attr("stroke-width", d => Math.max(1, d.width))
                .on("mouseover", function(event, d) {
                    tooltip
                        .style("opacity", 1)
                        .html(`<strong>${d.source.name}</strong> → <strong>${d.target.name}</strong><br/>Flow: ${Math.round(d.value).toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // Draw nodes
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(sankeyNodes)
                .enter()
                .append("g")
                .attr("class", "node");

            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", d => colors[d.type])
                .on("mouseover", function(event, d) {
                    let html = `<strong>${d.name}</strong>`;
                    if (d.type !== "hub") {
                        html += `<br/>Flow: ${Math.round(d.flow).toLocaleString()}`;
                    }
                    tooltip
                        .style("opacity", 1)
                        .html(html)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .call(d3.drag()
                    .on("start", function() {
                        this.parentNode.appendChild(this.parentNode);
                    })
                    .on("drag", dragged));

            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .each(function(d) {
                    // Handle multi-line text
                    const lines = d.name.split('\n');
                    if (lines.length > 1) {
                        d3.select(this).text(null);
                        const textElement = d3.select(this);
                        lines.forEach((line, i) => {
                            textElement.append("tspan")
                                .attr("x", d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                                .attr("dy", i === 0 ? "-0.3em" : "1.1em")
                                .text(line);
                        });
                    }
                });

            function dragged(event, d) {
                const rectHeight = d.y1 - d.y0;
                d.y0 = Math.max(0, Math.min(height - rectHeight, event.y));
                d.y1 = d.y0 + rectHeight;

                d3.select(this)
                    .attr("y", d.y0);

                d3.select(this.parentNode).select("text")
                    .attr("y", (d.y1 + d.y0) / 2);

                sankey.update({nodes: sankeyNodes, links: sankeyLinks});
                
                link.attr("d", d3.sankeyLinkHorizontal());
            }
        }).catch(error => {
            console.error("Error loading data:", error);
            d3.select("#chart").append("div")
                .style("padding", "20px")
                .style("color", "#e74c3c")
                .html(`<strong>Error loading data:</strong> ${error.message}`);
        });
    </script>
</body>
</html>