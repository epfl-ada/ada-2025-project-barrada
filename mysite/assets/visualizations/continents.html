<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reddit Network Graph</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: #ffffff;
      overflow: hidden;
    }

    #network-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .controls {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; z-index: 10;
      background: rgba(255,255,255,0.98);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .btn:hover { border-color: #ff4500; background: #fff5f2; }
    .btn.active { background: #ff4500; border-color: #ff4500; color: #fff; }

    /* Info panel (right) */
    .info-panel {
      position: absolute; top: 20px; right: 20px; width: 340px;
      background: rgba(255,255,255,0.98);
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      display: none;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 10;
    }
    .info-panel.active { display: block; animation: slideIn 0.25s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    .panel-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 12px;
      margin-bottom: 14px;
    }
    .info-panel h3 {
      margin: 0;
      font-size: 22px;
      color: #1a1a1a;
      line-height: 1.2;
      font-weight: 800;
    }

    .rep-title {
      font-size: 12px;
      color: #6a6a6a;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 0.8px;
    }
    .rep-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .rep-list li {
      background: #f0f2f5;
      margin-bottom: 6px;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* D3 */
    .link { transition: stroke-opacity 0.2s, stroke-width 0.2s; }
    .link.positive { stroke: #11ec20; stroke-opacity: 0.25; }
    .link.neutral  { stroke: #867e7e; stroke-opacity: 0.12; }
    .link.negative { stroke: #c62828; stroke-opacity: 0.35; }

    .node circle {
      stroke: #fff;
      stroke-width: 2.5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* Bigger cluster names */
    .node text {
      font-family: 'IBM Plex Sans', sans-serif;
      fill: #1a1a1a;
      font-weight: 800;
      font-size: 14px;
      pointer-events: none;
      paint-order: stroke;
      stroke: #fff;
      stroke-width: 4px;
    }

    .faded { opacity: 0.08 !important; }
    .active-link { stroke-opacity: 0.95 !important; stroke-width: 3.2px !important; }
    .active-node circle {
      stroke: #ff4500;
      stroke-width: 4px;
      filter: drop-shadow(0 0 8px rgba(255,69,0,0.45));
    }
  </style>
</head>

<body>
<div id="network-container">
  <div class="controls">
    <button class="btn active" id="toggle-labels">Labels: On</button>
    <button class="btn" id="recenter">Recenter</button>
  </div>

  <div id="info-panel" class="info-panel">
    <div class="panel-header">
      <h3 id="panel-name">Cluster</h3>
    </div>

    <div>
      <div class="rep-title">Representative Subreddits</div>
      <ul id="panel-reps" class="rep-list"></ul>
    </div>
  </div>
</div>

<script>
  const width = window.innerWidth;
  const height = window.innerHeight;

  const svg = d3.select("#network-container").append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g");

  const zoom = d3.zoom()
    .scaleExtent([0.3, 5])
    .on("zoom", (e) => g.attr("transform", e.transform));

  svg.call(zoom);

  let labelsOn = true;

  Promise.all([
    d3.json("../data/nodes.json"),
    d3.json("../data/edges.json")
  ]).then(([nodesRaw, edgesRaw]) => {

    const nodes = nodesRaw.map(d => ({
      ...d,
      pagerank: +d.pagerank || 0,
      internal_negativity: +d.internal_negativity || 0,
      size: +d.size || 0
    }));

    const edges = edgesRaw.map(e => ({
      ...e,
      sentiment: +e.sentiment
    }));

    const sizeScale = d3.scaleSqrt()
      .domain(d3.extent(nodes, d => d.pagerank))
      .range([16, 60]);

    const nodeColor = chroma.scale(['#11ec20', '#bdc3c7', '#c62828'])
      .domain([0, 10, 25])
      .mode('lab');

    const link = g.append("g")
      .selectAll("line")
      .data(edges)
      .enter()
      .append("line")
      .attr("class", d => {
        if (d.sentiment > 0.8) return "link positive";
        if (d.sentiment < 0.6) return "link negative";
        return "link neutral";
      })
      .attr("stroke-width", d => {
        if (d.sentiment < 0.6) return 3.0;
        if (d.sentiment > 0.8) return 2.2;
        return 1.2;
      });

    const node = g.append("g")
      .selectAll("g")
      .data(nodes, d => d.name)
      .enter()
      .append("g")
      .attr("class", "node")
      .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended)
      );

    node.append("circle")
      .attr("r", d => sizeScale(d.pagerank))
      .attr("fill", d => nodeColor(d.internal_negativity).hex());

    const label = node.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", d => sizeScale(d.pagerank) + 18)
      .text(d => d.name);

    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(edges).id(d => d.name).distance(280))
      .force("charge", d3.forceManyBody().strength(-1000))
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collide", d3.forceCollide().radius(d => sizeScale(d.pagerank) + 30))
      .on("tick", ticked);

    function ticked() {
      link
        .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

      node.attr("transform", d => `translate(${d.x},${d.y})`);
    }

    const panel = document.getElementById("info-panel");

    node.on("click", (event, d) => {
      event.stopPropagation();
      showPanel(d);
      highlightConnections(d);
    });

    svg.on("click", () => {
      panel.classList.remove("active");
      resetHighlight();
    });

    function showPanel(d) {
      panel.classList.add("active");
      document.getElementById("panel-name").innerText = d.name;

      const repsEl = document.getElementById("panel-reps");
      repsEl.innerHTML = "";

      const repsStr = (d.top_subreddits && typeof d.top_subreddits === "string")
        ? d.top_subreddits
        : "";

      if (repsStr.trim().length > 0) {
        const reps = repsStr.split(",").map(s => s.trim()).filter(Boolean).slice(0, 10);
        reps.forEach(sub => {
          const li = document.createElement("li");
          li.innerText = "r/" + sub;
          repsEl.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.innerText = "No representatives found (missing top_subreddits in nodes.json).";
        repsEl.appendChild(li);
      }
    }

    const linkedByIndex = {};

    function rebuildIndex() {
      Object.keys(linkedByIndex).forEach(k => delete linkedByIndex[k]);
      edges.forEach(d => {
        if (!d.source || !d.target) return;
        linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
        linkedByIndex[`${d.target.index},${d.source.index}`] = 1;
      });
    }

    setTimeout(rebuildIndex, 200);

    function isConnected(a, b) {
      return linkedByIndex[`${a.index},${b.index}`] || a.index === b.index;
    }

    function highlightConnections(selectedNode) {
      node.classed("faded", d => !isConnected(d, selectedNode));
      node.classed("active-node", d => d === selectedNode);

      link.classed("faded", d => d.source !== selectedNode && d.target !== selectedNode);
      link.classed("active-link", d => d.source === selectedNode || d.target === selectedNode);
    }

    function resetHighlight() {
      node.classed("faded", false).classed("active-node", false);
      link.classed("faded", false).classed("active-link", false);
    }

    const toggleBtn = document.getElementById("toggle-labels");
    toggleBtn.addEventListener("click", () => {
      labelsOn = !labelsOn;
      toggleBtn.classList.toggle("active", labelsOn);
      toggleBtn.textContent = labelsOn ? "Labels: On" : "Labels: Off";
      label.attr("display", labelsOn ? null : "none");
    });

    document.getElementById("recenter").addEventListener("click", () => {
      svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
      simulation.alpha(0.8).restart();
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.25).restart();
      d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x; d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }

  }).catch(err => {
    console.error("Failed to load data:", err);
    document.body.innerHTML = `<h3 style="text-align:center; margin-top: 50px; color: red">
      Error loading data. Check console + paths.
    </h3>`;
  });
</script>
</body>
</html>
