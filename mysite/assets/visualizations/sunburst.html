<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Architecture of Communities</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        h2 {
            font-family: Georgia, serif;
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }

        #chart-container {
            width: 100vw;
            height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* BREADCRUMBS (Top Left) */
        #breadcrumbs {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            pointer-events: none;
        }

        /* INFO PANEL (Center Overlay) */
        #explanation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            width: 200px;
            z-index: 10;
        }

        #percentage {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        #label-main {
            font-size: 1.2em;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        #label-desc {
            font-size: 0.8em;
            color: #777;
        }

        /* PATH STYLES */
        path {
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        path:hover {
            opacity: 0.8;
        }

        /* LEGEND */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 11px;
            text-align: left;
        }
        .legend-title { font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .swatch { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }

    </style>
</head>
<body>

    <h2>Fig 7. The Architecture of Influence</h2>
    <div class="subtitle">
        Hierarchical view of Reddit. <strong>Center:</strong> Social Roles. <strong>Outer Ring:</strong> Topic Clusters. 
        <br>Color represents <strong>Civility</strong> (Green = Polite, Red = Toxic). Click to zoom.
    </div>

    <div id="chart-container">
        <div id="breadcrumbs">Reddit</div>
        
        <div id="explanation" style="opacity: 0;">
            <div id="label-main">Name</div>
            <div id="percentage"></div>
            <div id="label-desc"></div>
        </div>
        
        <svg id="sunburst"></svg>
    </div>

    <div class="legend">
        <div class="legend-title">Civility Score</div>
        <div class="legend-item"><div class="swatch" style="background:#2ecc71"></div>Very Civil (>95%)</div>
        <div class="legend-item"><div class="swatch" style="background:#f1c40f"></div>Neutral (90-95%)</div>
        <div class="legend-item"><div class="swatch" style="background:#e67e22"></div>Mixed (80-90%)</div>
        <div class="legend-item"><div class="swatch" style="background:#e74c3c"></div>Toxic (<80%)</div>
    </div>

    <script>
        const width = window.innerWidth * 0.8;
        const height = window.innerHeight * 0.8;
        const radius = Math.min(width, height) / 2;

        // Color Scale for Civility (Green -> Red)
        const colorScale = d3.scaleLinear()
            .domain([75, 88, 95, 100]) // Domain based on Civility %
            .range(["#c0392b", "#e67e22", "#f1c40f", "#2ecc71"]) // Red, Orange, Yellow, Green
            .clamp(true);

        const svg = d3.select("#sunburst")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        // Partition Layout
        const partition = d3.partition()
            .size([2 * Math.PI, radius]);

        // Arc Generator
        const arc = d3.arc()
            .startAngle(d => d.x0)
            .endAngle(d => d.x1)
            .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
            .padRadius(radius / 2)
            .innerRadius(d => d.y0)
            .outerRadius(d => d.y1 - 1);

        async function init() {
            try {
                const nodes = await d3.json('../data/nodes.json');

                // 1. PROCESS DATA INTO HIERARCHY
                // We need to group clusters by their "Dominant Role"
                
                const hierarchyData = {
                    name: "Reddit",
                    children: [
                        { name: "Influential", children: [] },
                        { name: "Supportive", children: [] },
                        { name: "Controversial", children: [] },
                        { name: "Critical", children: [] },
                        { name: "Neutral", children: [] }
                    ]
                };

                // Helper to find index of role in hierarchyData
                const roleMap = {
                    "Influential": 0, "Supportive": 1, 
                    "Controversial": 2, "Critical": 3, "Neutral": 4
                };

                nodes.forEach(node => {
                    // Determine dominant role
                    const roles = [
                        { id: 'Influential', val: node.pct_influential },
                        { id: 'Supportive', val: node.pct_supportive },
                        { id: 'Controversial', val: node.pct_controversial },
                        { id: 'Critical', val: node.pct_critical }
                    ];
                    roles.sort((a,b) => b.val - a.val);
                    
                    // Threshold: If top role is < 5%, class as Neutral
                    let domRole = roles[0].val > 5 ? roles[0].id : "Neutral";
                    
                    // Create child node
                    const child = {
                        name: node.name,
                        value: node.size, // Size by number of subreddits
                        civility: 100 - node.internal_negativity,
                        // Store detailed stats for tooltip
                        top_subs: node.top_subreddits
                    };

                    hierarchyData.children[roleMap[domRole]].children.push(child);
                });

                // Remove empty role categories
                hierarchyData.children = hierarchyData.children.filter(c => c.children.length > 0);

                // 2. BUILD HIERARCHY
                const root = d3.hierarchy(hierarchyData)
                    .sum(d => d.value)
                    .sort((a, b) => b.value - a.value);

                partition(root);

                // 3. RENDER
                const path = svg.selectAll("path")
                    .data(root.descendants().filter(d => d.depth)) // Hide root circle
                    .join("path")
                    .attr("d", arc)
                    .style("fill", d => {
                        // If leaf (Cluster), color by Civility
                        if (d.depth === 2) return colorScale(d.data.civility);
                        
                        // If parent (Role), color by average of children
                        if (d.depth === 1) {
                            const avgCivility = d3.mean(d.children, c => c.data.civility);
                            return colorScale(avgCivility);
                        }
                        return "#ddd";
                    })
                    .on("mouseover", mouseover)
                    .on("mouseleave", mouseleave)
                    .on("click", click);

                // 4. INTERACTION FUNCTIONS
                
                function mouseover(event, d) {
                    // Dim all paths
                    svg.selectAll("path").style("opacity", 0.3);
                    
                    // Highlight ancestors
                    svg.selectAll("path")
                        .filter(node => d.ancestors().indexOf(node) >= 0)
                        .style("opacity", 1);

                    // Update Info Center
                    const percentage = ((d.value / root.value) * 100).toFixed(1);
                    const name = d.data.name;
                    let desc = "";

                    if (d.depth === 1) {
                        desc = `${d.children.length} Clusters inside`;
                    } else if (d.depth === 2) {
                        desc = `Civility: ${d.data.civility.toFixed(1)}%<br>Size: ${d.value} Subs`;
                    }

                    d3.select("#percentage").text(percentage + "%");
                    d3.select("#label-main").text(name);
                    d3.select("#label-desc").html(desc);
                    d3.select("#explanation").style("opacity", 1);
                    
                    // Update Breadcrumbs
                    const sequence = d.ancestors().map(d => d.data.name).reverse();
                    d3.select("#breadcrumbs").text(sequence.join(" > "));
                }

                function mouseleave() {
                    svg.selectAll("path").style("opacity", 1);
                    d3.select("#explanation").style("opacity", 0);
                    d3.select("#breadcrumbs").text("Reddit");
                }

                function click(event, d) {
                    svg.transition()
                        .duration(750)
                        .tween("scale", () => {
                            const xd = d3.interpolate(root.x0, d.x0),
                                  yd = d3.interpolate(root.y0, d.y0),
                                  yr = d3.interpolate(root.y1, d.y1);
                            return t => { root.x0 = xd(t); root.y0 = yd(t); root.y1 = yr(t); };
                        })
                        .selectAll("path")
                        .attrTween("d", d => () => arc(d));
                }

            } catch (e) {
                document.body.innerHTML = `<h3 style="color:red">Error: ${e.message}</h3>`;
            }
        }

        init();
    </script>
</body>
</html>