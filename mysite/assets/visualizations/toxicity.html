<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toxicity Flow Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <style>
        /* ACADEMIC STYLE CSS */
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: #2c3e50;
            margin-bottom: 5px;
            font-weight: normal;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        #chart-container {
            width: 100%;
            max-width: 1000px;
            height: 600px;
            background: #fff;
            border: 1px solid #e0e0e0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }

        .node rect {
            fill-opacity: 0.9;
            shape-rendering: crispEdges;
            stroke-width: 0;
        }

        .node text {
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
        }

        .link {
            fill: none;
            stroke-opacity: 0.2;
            transition: stroke-opacity 0.3s;
        }

        .link:hover {
            stroke-opacity: 0.5;
        }

        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #999;
            padding: 8px;
            font-size: 11px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-family: monospace;
            z-index: 10;
            max-width: 200px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-box {
            width: 12px;
            height: 12px;
            margin-right: 6px;
        }
    </style>
</head>
<body>

    <h2>Fig 3. Net Toxicity Flow Analysis</h2>
    <div class="subtitle">Visualizing the asymmetry between "Net Aggressors" (Left) and "Net Victims" (Right).</div>

    <div id="chart-container"></div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-box" style="background: #A63434;"></div>
            <span>Net Aggressors (Export > Import)</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: #ccc;"></div>
            <span>Systemic Toxicity Transfer</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: #4A6FA5;"></div>
            <span>Net Victims (Import > Export)</span>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // --- CONFIGURATION ---
        const MARGIN = {top: 40, right: 150, bottom: 40, left: 150};
        const WIDTH = 1000 - MARGIN.left - MARGIN.right;
        const HEIGHT = 600 - MARGIN.top - MARGIN.bottom;
        
        // Academic Color Palette
        const COLOR_BULLY = "#A63434";  // Muted Red
        const COLOR_VICTIM = "#4A6FA5"; // Muted Blue
        const COLOR_VOID = "#cccccc";   // Neutral Grey

        async function initVisualization() {
            try {
                // 1. Load BOTH Datasets using Promise.all
                // We load toxicity.json for the flow data and nodes.json to look up names
                const [toxicityData, nodesData] = await Promise.all([
                    d3.json('../data/toxicity.json'),
                    d3.json('../data/nodes.json')
                ]);
                
                // 2. Data Transformation
                const nodes = [];
                const links = [];
                
                // Helper to get name from ID
                // We assume nodes.json is an array where index matches the cluster ID
                const getName = (idStr) => {
                    const id = parseInt(idStr);
                    if (nodesData[id] && nodesData[id].name) {
                        return nodesData[id].name;
                    }
                    return "Cluster " + id;
                };

                // --- Create Nodes ---
                
                // Central Node (The Reddit Ether)
                const voidNodeIndex = 0;
                nodes.push({ name: "Systemic Toxicity", type: "void" });
                
                let currentIndex = 1;
                
                // Bully Nodes (Left Side)
                toxicityData.bullies.forEach(bully => {
                    nodes.push({
                        ...bully,
                        nodeId: currentIndex,
                        type: "bully",
                        // Map ID to Name here
                        displayName: getName(bully.cluster) 
                    });
                    
                    links.push({
                        source: currentIndex,
                        target: voidNodeIndex,
                        value: Math.abs(bully.net_flow)
                    });
                    currentIndex++;
                });

                // Victim Nodes (Right Side)
                toxicityData.victims.forEach(victim => {
                    nodes.push({
                        ...victim,
                        nodeId: currentIndex,
                        type: "victim",
                        // Map ID to Name here
                        displayName: getName(victim.cluster)
                    });
                    
                    links.push({
                        source: voidNodeIndex,
                        target: currentIndex,
                        value: Math.abs(victim.net_flow)
                    });
                    currentIndex++;
                });

                // 3. Setup SVG
                const svg = d3.select("#chart-container").append("svg")
                    .attr("width", WIDTH + MARGIN.left + MARGIN.right)
                    .attr("height", HEIGHT + MARGIN.top + MARGIN.bottom)
                    .append("g")
                    .attr("transform", `translate(${MARGIN.left},${MARGIN.top})`);

                // 4. Configure Sankey
                const sankey = d3.sankey()
                    .nodeWidth(20)
                    .nodePadding(20)
                    .extent([[0, 0], [WIDTH, HEIGHT]]);

                // Generate Layout
                const {nodes: graphNodes, links: graphLinks} = sankey({
                    nodes: nodes.map(d => Object.assign({}, d)),
                    links: links.map(d => Object.assign({}, d))
                });

                // 5. Draw Links
                svg.append("g")
                    .selectAll("path")
                    .data(graphLinks)
                    .join("path")
                    .attr("class", "link")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("stroke", d => {
                        if (d.source.type === 'bully') return "url(#gradient-bully)";
                        return "url(#gradient-victim)";
                    })
                    .attr("stroke-width", d => Math.max(1, d.width))
                    .style("stroke", "#999")
                    .on("mouseover", (event, d) => {
                        // Determine which name to show based on flow direction
                        const entityName = d.source.type === 'bully' ? d.source.displayName : d.target.displayName;
                        
                        d3.select("#tooltip")
                            .style("opacity", 1)
                            .html(`<strong>${entityName}</strong><br>
                                   Net Flow: ${d.value.toLocaleString()} links`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));

                // 6. Draw Nodes
                svg.append("g")
                    .selectAll("rect")
                    .data(graphNodes)
                    .join("rect")
                    .attr("class", "node")
                    .attr("x", d => d.x0)
                    .attr("y", d => d.y0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("width", d => d.x1 - d.x0)
                    .attr("fill", d => {
                        if (d.type === 'bully') return COLOR_BULLY;
                        if (d.type === 'victim') return COLOR_VICTIM;
                        return COLOR_VOID;
                    });

                // 7. Draw Labels
                svg.append("g")
                    .style("font", "11px Helvetica")
                    .selectAll("text")
                    .data(graphNodes)
                    .join("text")
                    .attr("x", d => d.x0 < WIDTH / 2 ? d.x1 + 6 : d.x0 - 6)
                    .attr("y", d => (d.y1 + d.y0) / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", d => d.x0 < WIDTH / 2 ? "start" : "end")
                    .text(d => d.type === 'void' ? "" : d.displayName) 
                    .style("font-weight", "bold")
                    .style("fill", "#333");

                // Add value labels (Net Flow) underneath names
                svg.append("g")
                    .style("font", "10px sans-serif")
                    .selectAll("text")
                    .data(graphNodes)
                    .join("text")
                    .attr("x", d => d.x0 < WIDTH / 2 ? d.x1 + 6 : d.x0 - 6)
                    .attr("y", d => (d.y1 + d.y0) / 2 + 14) 
                    .attr("text-anchor", d => d.x0 < WIDTH / 2 ? "start" : "end")
                    .text(d => d.type === 'void' ? "" : `Net: ${d3.format(",")(Math.abs(d.net_flow))}`)
                    .style("fill", "#777"); // Slightly lighter for the number

            } catch (error) {
                console.error("Error loading data:", error);
                d3.select("#chart-container").append("div")
                    .style("padding", "20px")
                    .style("color", "red")
                    .text("Error loading data files. Please ensure both '../data/toxicity.json' and '../data/nodes.json' exist.");
            }
        }

        initVisualization();

    </script>
</body>
</html>